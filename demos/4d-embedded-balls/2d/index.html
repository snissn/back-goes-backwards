<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Breath Cycle Spiral Animation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #fff;
      }
    </style>
  </head>
  <body>
    <script>
      let outerRadius, innerRadius;
      const breathPeriod = 4000;
      const nParticles = 80;

      function setup() {
        createCanvas(windowWidth, windowHeight);
        angleMode(RADIANS);
        outerRadius = min(width, height) * 0.3;
        innerRadius = outerRadius * 0.5;
      }

      function draw() {
        background(255);
        const cx = width / 2;
        const cy = height / 2;

        stroke(0);
        strokeWeight(2);
        noFill();
        ellipse(cx, cy, outerRadius * 2 + 20, outerRadius * 2 + 20);
        ellipse(cx, cy, innerRadius * 2, innerRadius * 2);

        const currentTime = millis();
        const phase = (currentTime % breathPeriod) / breathPeriod;
        const f = (1 - cos(TWO_PI * phase)) / 2;

        const theta = 3 * PI / 2; // point of heart fixed on bottom (outer circle)
        const nParticlesDrawn = Math.floor(nParticles * (0.5 + 0.5 * f));
        const totalSpread = PI;
        const centerIndex = (nParticlesDrawn - 1) / 2;

        let points = [];

        for (let i = 0; i < nParticlesDrawn; i++) {
          const offset = i - centerIndex;
          const angleOffset = totalSpread * (offset / centerIndex);
          const angle = theta - angleOffset;

          const relativeLift = 1 - abs(offset / centerIndex);
          const particle_radius = outerRadius - (outerRadius - innerRadius) * relativeLift * f;

          const x = cx + particle_radius * cos(angle);
          const y = cy + particle_radius * sin(angle);

          points.push({ x, y });
        }

        // Draw connecting curve and explicitly close the loop
        noFill();
        stroke(0);
        strokeWeight(2);
        beginShape();
        // Add two leading control points to make curveVertex close properly
        curveVertex(points[points.length - 2].x, points[points.length - 2].y);
        for (let pt of points) {
          curveVertex(pt.x, pt.y);
        }
        // Add two trailing control points to ensure the last segment closes
        curveVertex(points[0].x, points[0].y);
        curveVertex(points[1].x, points[1].y);
        endShape();

        // Draw points and vectors
        for (let pt of points) {
          const x = pt.x;
          const y = pt.y;

          noStroke();
          fill(0);
          ellipse(x, y, 10, 10);

          stroke(100);
          strokeWeight(1);
          line(cx, cy, x, y);
        }
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
        outerRadius = min(width, height) * 0.3;
        innerRadius = outerRadius * 0.5;
      }
    </script>
  </body>
</html>

